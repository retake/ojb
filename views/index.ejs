<!DOCTYPE html>
<script src="/socket.io/socket.io.js"></script>
<script type="text/javascript">


  // 変数宣言
  var uploading_flg = false;
  var upload_que = [];
  var sessid = null; 
  var playlist = [];
  var userlist = [];
  var playing_file_info = "";

  var audio_mime_types = getAudioMimeTypes();
  var video_mime_types = getVideoMimeTypes();
  var mime_types = audio_mime_types.concat(video_mime_types);
  console.log(mime_types);

  var media = undefined;

  // websocket接続開始
  var address = '<%=conf.host%>:<%=conf.port%>';
  var socket = io.connect(address);

   // 接続開始完了時の処理
  socket.on('<%=conf.soc_msgs.conn%>', function(msg) {
    console.log('<%=conf.soc_msgs.conn%>');
    sessid = socket.socket.transport.sessid;
    document.getElementById("name").value = sessid;
 
    // mediaの初期化
    media = document.getElementById("media");
    media.style.display = "none";
    media.preload = 'metadata';
    media.addEventListener("ended", function(e){
      mediastop();
      if (playlist[0].sessid == sessid && playing_file_info=='player'){
        socket.emit('<%=conf.soc_msgs.playend%>', playlist[0]);
      }
    },false);
    media.addEventListener("loadedmetadata", function(e){
      if (playlist[0].sessid == sessid){
        playing_file_info = 'player';
        mediastart();
      } else {
        playing_file_info = 'listener';
        socket.emit('<%=conf.soc_msgs.getcurrenttime%>',{});
      }
      console.log(playing_file_info);
    }, false);

    //buttonの初期化
    document.getElementById('disconnect_btn').style.display = "";
    document.getElementById('reconnect_btn').style.display = "none";
  });

  // メディア再生処理
  function mediastart(){
    var filetype = playlist[0].filetype;
    for ( var mimetype in audio_mime_types){
      if ( filetype == mimetype ) {
        media.style.display = "none";
      } else if ( filetype == 'video/mp4' ){
        media.style.display = "";
      }
    }
    media.play();
  }

  // メディア停止処理
  function mediastop(){
    media.style.display = "none";
    media.pause();
  }

  // 画面更新時の処理
  window.onbeforeunload = function(){
    disConnect();
  }

  // 切断時の処理
  function disConnect() {
    var yourname = getDispName(sessid);
    document.getElementById('name').innerHTML = '<font color=\'red\'><b>'+yourname+'</b></font> は死んでしまった！';
    if(media!=undefined && media.ended==false){
      mediastop();
    }
    socket.disconnect({sessid:sessid});
    document.getElementById('disconnect_btn').style.display = "none";
    document.getElementById('reconnect_btn').style.display = "";
  }

  // 再接続時の処理
  function reConnect() {
   document.getElementById('disconnect_btn').style.display = "";
   document.getElementById('reconnect_btn').style.display = "none";
   // 再接続は、１度作ったsocketから行う。何故かは不明。
   socket.socket.connect(address);
  }

 // 再生停止通知受信時の処理
  socket.on('<%=conf.soc_msgs.playstop%>', function(data) {
    console.log('<%=conf.soc_msgs.playstop%>');
    mediastop();
  });

  // 再生開始時の処理
  socket.on('<%=conf.soc_msgs.playstart%>', function(startTime) {
    console.log('<%=conf.soc_msgs.playstart%>');
    media.src = './mediadata/'+playlist[0].filename;
    mediastart();
  });

  // 最新再生時刻受信時
  socket.on('<%=conf.soc_msgs.retcurrenttime%>', function(data) {
    console.log('<%=conf.soc_msgs.retcurrenttime%>');
    media.currentTime = data;
    mediastart();
  });

  // プレイリスト更新通知受信時の処理
  socket.on('<%=conf.soc_msgs.updateplaylist%>', function(data) {
    console.log('<%=conf.soc_msgs.updateplaylist%>');
    playlist = data;
    createPlayListTable();
    createUserListTable();
  });

  // プレイリストテーブル最新化
  function createPlayListTable(){
    var playlist_elm = document.getElementById("playlist");
    var playlist_str = "";
    var filename = null;
    var color = null;
    var btn_sts = "";
    var playinfo_elm = document.getElementById('playinginfo');
    playinfo_elm.innerHTML = "";
    playlist_str = '<table>';
    playlist_str = playlist_str.concat('<caption>プレイリスト</caption>');
    playlist_str = playlist_str.concat('<tr>');
    playlist_str = playlist_str.concat('<th class=\'no\'>no</th>');
    playlist_str = playlist_str.concat('<th class=\'id\'>ID/name</th>');
    playlist_str = playlist_str.concat('<th class=\'filename\'>filename</th>');
    playlist_str = playlist_str.concat('<th class=\'remove\'>remove</th>');
    playlist_str = playlist_str.concat('</tr>');
    if (playlist.length>0) {
      for (var i=0; i<playlist.length; i++){
        var trclass = "";
        filename = playlist[i].filename;
        if (sessid == playlist[i].sessid) {
          trclass = "mydata";
          btn_sts = "";
        } else {
          trclass = "otherdata";
          btn_sts = "disabled";
        }
        if (i==0){
          playinfo_elm.innerHTML = '再生中: <b>' + filename + '</b>';
        }
        playlist_str = playlist_str.concat('<tr class='+trclass+'>');
        playlist_str = playlist_str.concat('<td class=\'no\'>'+(i+1)+'</td>');
        playlist_str = playlist_str.concat('<td class=\'id\'>'+getDispName(playlist[i].sessid)+'</td>');
        playlist_str = playlist_str.concat('<td class=\'file\'>'+filename+'</td>');
        playlist_str = playlist_str.concat('<td class=\'remove\'><input type=button value=\'削除\' onclick="removefile('+i+')" '+btn_sts+'/></td>');
        playlist_str = playlist_str.concat('</tr>');
      } 
    } else {
      playlist_str = playlist_str.concat('<tr class="nofiletr">');
      playlist_str = playlist_str.concat('<td colspan="4">nofile</th>');
      playlist_str = playlist_str.concat('</tr>');
    }
    playlist_str = playlist_str.concat('</table>');
    playlist_elm.innerHTML = playlist_str;
  }

  // ユーザーリストテーブル最新化
  function createUserListTable(){
    var userlist_elm = document.getElementById('userlist');
    var userlist_str = "";
    if (userlist.length>0) {
      userlist_str = '<table>';
      userlist_str = userlist_str.concat('<caption>接続ユーザリスト<caption>');
      userlist_str = userlist_str.concat('<tr>');
      userlist_str = userlist_str.concat('<th class=\'no\'>no</th>');
      userlist_str = userlist_str.concat('<th class=\'id\'>ID/name</th>');
      userlist_str = userlist_str.concat('</tr>');
      for (var i=0; i<userlist.length; i++){
        var trclass = "";
        var username = userlist[i].dispname;
        if (sessid == userlist[i].sessid) {
          trclass = "mydata";
        } else {
          trclass = "otherdata";
        }
        userlist_str = userlist_str.concat('<tr class="'+trclass+'">');
        userlist_str = userlist_str.concat('<td class=\'no\'>'+(i+1)+'</td>');
        userlist_str = userlist_str.concat('<td class=\'id\'>'+username+'</td>');
        userlist_str = userlist_str.concat('</tr>');
      } 
      userlist_str = userlist_str.concat('</table>');
    }
    userlist_elm.innerHTML = userlist_str;
  }

  // ユーザーリスト受信時の処理
  socket.on('<%=conf.soc_msgs.updateuserlist%>',function(newuserlist){
    userlist = newuserlist;
    var yourname = getDispName(sessid);
    document.getElementById('name').innerHTML = 'よくぞまいった <font color=\'red\'><b>'+yourname+'</b></font> よ！';
    createPlayListTable();
    createUserListTable();
  });

  // セッションIDから表示名を取得
  function getDispName(srcid){
    var dispname = "";
    for (var i=0; i<userlist.length; i++){
      if (srcid == userlist[i].sessid){
        dispname = userlist[i].dispname;
        break;
      }
    }
    return dispname;
  }

  // ファイル削除通知送信
  function removefile(fileno) {
    socket.emit('<%=conf.soc_msgs.removefile%>',{filename:playlist[fileno].filename});
  }

  // ファイル送信
  function SendFile(file) {
    socket.emit('<%=conf.soc_msgs.uploadfile%>',file,function(data){
      if (data=="success"){
        changeUploadStatusView(file.name,"upload_complete");
      }
    });
  }

  // 一秒置きに 再生中ファイルの時間を送信
  setInterval( function(){
    if (playlist.length != 0 && playlist[0].sessid == sessid && media != undefined){
      socket.emit('<%=conf.soc_msgs.sendcurrenttime%>', {value:media.currentTime});
    }
  },1000);

  // ファイルDrop時の制御
  function handleFileSelect(e) {
    var file = null;
    var reader = new FileReader();
    var filename = null;

    e.stopPropagation();
    e.preventDefault();
    
    // 各ファイルをupload用のqueに登録
    files = e.dataTransfer.files;
    for(var i=0; i<files.length; i++){
      upload_que.push({file:files[i],filename:files[i].name});
    }
  }

  // 3秒に1度、送信中のファイルが無ければupload用queの中身を送る
  setInterval(function(){
    if( upload_que.length !=0 && uploading_flg == false){
      uploading_flg = true;
      var reader = new FileReader();
      var file = upload_que[0].file;
      var filename = upload_que[0].filename;
      if ( checkFileType(file.type) ){
        changeUploadStatusView(filename,"uploading");
        reader.onload = function(readed) {
          SendFile({file:readed.target.result, name:filename, filetype:file.type});
          upload_que.shift();
        uploading_flg = false;
        }
      } else {
        changeUploadStatusView(filename,"denied");
        upload_que.shift();
        uploading_flg = false;
      }
      reader.readAsBinaryString(file);
    }
  },3000);

  function checkFileType(filetype){
    for (var i=0; i<mime_types.length; i++){
      if (mime_types[i] == filetype){
        return true;
      }
    }
    return false;
  }

  function getAudioMimeTypes(){
    var audioArray= [
      <%for (var i=0; i<conf.mime_types.audio.length; i++){%>
        '<%=conf.mime_types.audio[i]%>',
      <%}%>
    ];
    return audioArray;
  }

  function getVideoMimeTypes(){
    var videoArray= [
      <%for (var i=0; i<conf.mime_types.video.length; i++){%>
        '<%=conf.mime_types.video[i]%>',
      <%}%>
    ];
    return videoArray;
  }


  // dropzoneの上をdragした場合の制御
  function handleDragOver(e) {
    e.stopPropagation();
    e.preventDefault();
    e.dataTransfer.dropEffect = 'test';
  }

  // 表示名変更送信
  function changeName() {
    var newname = document.getElementById('newname').value
    socket.emit('<%=conf.soc_msgs.changename%>',newname);
  }

  // ファイル送信状況の表示
  function changeUploadStatusView(filename,st_flg) {
    var upload_status_view = document.getElementById('upload_status_view');
    view_str = "";
    if (st_flg=="uploading"){
      view_str = '<font size="14"><b> 『' + filename + '』 を設定中！</b></font>';
    } else if (st_flg=='upload_complete'){
      view_str = '<font size="14"><b> 『' + filename + '』 設定終了！</b></font>';
    }
    upload_status_view.innerHTML = view_str;

    if (st_flg=='denied'){
      document.getElementById('upload_fails').innerHTML = '『' + filename +'』は対応していない形式です';
    }
  }

  // 名前変更のenterkeyでの処理
  function changeNameFromEnter(keycode) {
    if (keycode==13) {
      changeName();
    }
  }

</script>


<html>
  <head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
  </head>
  <body>
    <div id="dropzone" ondrop="handleFileSelect(event)" ondragover="handleDragOver(event)">
      <font size=32 color="white">追加したいファイルをドロップ</font>
      <div id='upload_status_view'></div>
      <div id='upload_fails'></div>
    </div>
    <br>
    <div id="name"></div>
    <br>
    <div id="playinginfo"></div>
    <br>
    <div id='mainarea'>
      <div id="playlist"></div>
      <video id='media'></video>
    </div>
    <br>
    <div id="userlist"></div>
    <br>
    <input type="text" id="newname" onkeypress="changeNameFromEnter(event.keyCode);" />
    <input type="button" value="名前を変更" onclick="changeName();" />
    <input type="button"  id="disconnect_btn" value="切断" onclick="disConnect();" />
    <input type="button"  id="reconnect_btn" value="再接続" onclick="reConnect();" />
  </body>
</html>

